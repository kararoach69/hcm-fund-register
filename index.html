<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HCM Fund Register</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; max-width:1200px; margin:auto; padding:20px; background:#f5f5f5 }
.section { background:#fff; padding:20px; margin:20px 0; border-radius:8px }
input, textarea, button, select { padding:8px; margin:4px }
button { background:#007bff; color:#fff; border:none; cursor:pointer }
button:hover { background:#0056b3 }
.btn-delete { background:#dc3545 }
.btn-edit { background:#ffc107; color:#000 }
.btn-new-fy, .btn-pdf { background:#28a745 }
table { width:100%; border-collapse:collapse; margin-top:10px }
th, td { border:1px solid #ddd; padding:6px }
th { background:#f0f0f0 }
.positive { color:green }
.negative { color:red }
.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.5) }
.modal-content { background:#fff; margin:10% auto; padding:20px; width:90%; max-width:500px }
.close { float:right; cursor:pointer; font-size:22px }
</style>
</head>

<body>

<h1>High Court of Manipur â€“ Fund Register</h1>

<div class="section">
<h2>
Financial Year
<select id="fySelector" onchange="switchFinancialYear()"></select>
<button class="btn-new-fy" onclick="createNewFY()">âž• New FY</button>
</h2>
<div id="currentBudget"></div>
</div>

<div class="section">
<h2>Add Bill</h2>
<input type="date" id="billDate">
<input placeholder="CMIS Bill No" id="cmisBill">
<input placeholder="Dept Bill No" id="deptBill">
<textarea id="particulars" placeholder="Particulars"></textarea>
<input type="number" placeholder="Sanction Amount" id="sanctionAmt">
<input type="number" placeholder="Salary Amount" id="salAmt">
<button onclick="addBill()">Add Bill</button>
</div>

<div class="section">
<h2>Summary</h2>
<div id="summary"></div>
</div>

<div class="section">
<h2>Bills <button class="btn-pdf" onclick="generateBillsPDF()">ðŸ“„ PDF</button></h2>
<table id="billsTable">
<thead>
<tr>
<th>Date</th><th>CMIS</th><th>Particulars</th>
<th>Sanction</th><th>Salary</th>
<th>Sal Exp</th><th>Sal Bal</th>
<th>All Exp</th><th>All Bal</th><th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- EDIT MODAL -->
<div id="editModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">&times;</span>
<h3>Edit Bill</h3>
<input type="date" id="editDate">
<input id="editCmis">
<input id="editDept">
<textarea id="editPart"></textarea>
<input type="number" id="editSanction">
<input type="number" id="editSal">
<button onclick="saveEdit()">Save</button>
</div>
</div>

<script>
/* ================== GITHUB CONFIG ================== */
const GITHUB_OWNER = "kararoach69";
const GITHUB_REPO  = "hcm-fund-register";
const GITHUB_PATH  = "data";
const GITHUB_TOKEN = "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";
const API = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_PATH}`;

/* ================== STATE ================== */
let data = { fy:'', salBudget:0, allBudget:0, bills:[] };
let editIndex = -1;

/* ================== HELPERS ================== */
const headers = () => ({
  Authorization: `token ${GITHUB_TOKEN}`,
  Accept: "application/vnd.github+json"
});
const rupees = n => new Intl.NumberFormat('en-IN').format(n);

/* ================== GITHUB IO ================== */
async function loadFY(fy){
  const r = await fetch(`${API}/${fy}.json`, { headers: headers() });
  if(r.status === 404){
    data = { fy, salBudget:0, allBudget:0, bills:[] };
    return saveFY();
  }
  const f = await r.json();
  data = JSON.parse(atob(f.content));
  data.sha = f.sha;
}

async function saveFY(){
  const body = {
    message:`Update ${data.fy}`,
    content:btoa(JSON.stringify(data,null,2))
  };
  if(data.sha) body.sha = data.sha;
  const r = await fetch(`${API}/${data.fy}.json`,{
    method:"PUT",
    headers: headers(),
    body: JSON.stringify(body)
  });
  data.sha = (await r.json()).content.sha;
}

/* ================== FY ================== */
function generateFYOptions(){
  fySelector.innerHTML = '<option value="">Select FY</option>';
  const y = new Date().getFullYear();
  for(let i=5;i>=0;i--){
    const fy = `${y-i}-${(y-i+1).toString().slice(-2)}`;
    fySelector.add(new Option(fy,fy));
  }
}

async function switchFinancialYear(){
  const fy = fySelector.value;
  if(!fy) return;
  await loadFY(fy);
  calcAll();
  render();
}

function createNewFY(){
  const fy = prompt("Enter FY (2026-27)");
  if(fy) { fySelector.value = fy; switchFinancialYear(); }
}

/* ================== LOGIC ================== */
function calcAll(){
  data.bills.forEach((b,i)=>{
    b.salExp = data.bills.slice(0,i+1).reduce((s,x)=>s+x.salAmt,0);
    b.allExp = data.bills.slice(0,i+1).reduce((s,x)=>s+(x.sanctionAmt-x.salAmt),0);
    b.salBal = data.salBudget - b.salExp;
    b.allBal = data.allBudget - b.allExp;
  });
}

/* ================== CRUD ================== */
async function addBill(){
  if(!billDate.value || !deptBill.value) return alert("Date & Dept Bill required");
  data.bills.push({
    date:billDate.value,
    cmisBill:cmisBill.value,
    deptBill:deptBill.value,
    particulars:particulars.value,
    sanctionAmt:+sanctionAmt.value||0,
    salAmt:+salAmt.value||0
  });
  calcAll(); await saveFY(); render();
}

function editBill(i){
  editIndex=i;
  const b=data.bills[i];
  editDate.value=b.date;
  editCmis.value=b.cmisBill;
  editDept.value=b.deptBill;
  editPart.value=b.particulars;
  editSanction.value=b.sanctionAmt;
  editSal.value=b.salAmt;
  editModal.style.display="block";
}

async function saveEdit(){
  Object.assign(data.bills[editIndex],{
    date:editDate.value,
    cmisBill:editCmis.value,
    deptBill:editDept.value,
    particulars:editPart.value,
    sanctionAmt:+editSanction.value||0,
    salAmt:+editSal.value||0
  });
  calcAll(); await saveFY(); closeModal(); render();
}

async function deleteBill(i){
  if(!confirm("Delete bill?")) return;
  data.bills.splice(i,1);
  calcAll(); await saveFY(); render();
}

function closeModal(){ editModal.style.display="none" }

/* ================== RENDER ================== */
function render(){
  currentBudget.innerHTML = `<b>FY ${data.fy}</b>`;
  const tbody = billsTable.querySelector("tbody");
  tbody.innerHTML="";
  data.bills.forEach((b,i)=>{
    tbody.insertRow().innerHTML=`
    <td>${b.date}</td>
    <td>${b.cmisBill}</td>
    <td>${b.particulars}</td>
    <td>â‚¹${rupees(b.sanctionAmt)}</td>
    <td>â‚¹${rupees(b.salAmt)}</td>
    <td>â‚¹${rupees(b.salExp)}</td>
    <td class="${b.salBal>=0?'positive':'negative'}">â‚¹${rupees(b.salBal)}</td>
    <td>â‚¹${rupees(b.allExp)}</td>
    <td class="${b.allBal>=0?'positive':'negative'}">â‚¹${rupees(b.allBal)}</td>
    <td>
      <button class="btn-edit" onclick="editBill(${i})">Edit</button>
      <button class="btn-delete" onclick="deleteBill(${i})">Delete</button>
    </td>`;
  });
}

/* ================== PDF ================== */
function generateBillsPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text(`HCM Fund Register FY ${data.fy}`,20,20);
  let y=30;
  data.bills.forEach((b,i)=>{
    doc.text(`${i+1}. ${b.date} | â‚¹${b.sanctionAmt}`,20,y);
    y+=8;
    if(y>270){ doc.addPage(); y=20; }
  });
  doc.save(`HCM_${data.fy}.pdf`);
}

/* ================== INIT ================== */
generateFYOptions();
fySelector.value = "2026-27";
switchFinancialYear();
</script>

</body>
</html>
