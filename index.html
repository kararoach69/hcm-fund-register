<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCM Fund Register</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, textarea, button, select { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { width: 100%; height: 60px; resize: vertical; }
        button { background: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background: #0056b3; }
        .btn-delete { background: #dc3545 !important; }
        .btn-delete:hover { background: #c82333 !important; }
        .btn-edit { background: #ffc107 !important; color: #212529 !important; }
        .btn-edit:hover { background: #e0a800 !important; }
        .btn-pdf { background: #28a745 !important; }
        .btn-new-fy { background: #28a745 !important; }
        .edit-budget { background: #17a2b8 !important; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
        .balance { font-weight: bold; font-size: 1.1em; }
        .positive { color: green; }
        .negative { color: red; }
        #summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .budget-box { background: #e7f3ff; padding: 15px; border-radius: 5px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; cursor: pointer; }
        .action-col { text-align: center; white-space: nowrap; width: 160px; }
    </style>
</head>
<body>
    <h1>High Court of Manipur - Fund Register</h1>

    <div class="section">
        <h2>Financial Year 
            <select id="fySelector" onchange="switchFinancialYear()" style="padding: 5px; margin-left: 10px;">
                <option value="">Select FY</option>
            </select>
            <button class="edit-budget" onclick="openBudgetModal()" style="font-size: 14px; padding: 5px 10px;">Edit Budget</button>
            <button class="btn-new-fy" onclick="createNewFY()" style="font-size: 14px; padding: 5px 10px;">âž• New FY</button>
        </h2>
        <div id="currentBudget"></div>
    </div>

    <div class="section">
        <h2>Add Bill</h2>
        <input type="date" id="billDate">
        <input type="text" id="cmisBill" placeholder="CMIS Bill Number">
        <input type="text" id="deptBill" placeholder="Department Bill Number">
        <textarea id="particulars" placeholder="Particulars of Bill (Detailed Description)"></textarea>
        <input type="number" id="sanctionAmt" step="0.01" placeholder="Sanction Amount">
        <input type="number" id="salAmt" step="0.01" placeholder="Amount on Salaries">
        <button onclick="addBill()">Add Bill</button>
    </div>

    <div class="section">
        <h2>Fund Summary</h2>
        <div id="summary"></div>
    </div>

    <div class="section">
        <h2>Bills List <button class="btn-pdf" onclick="generateBillsPDF()">ðŸ“„ Export Bills PDF</button></h2>
        <table id="billsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Dept Bill (HCM/)</th>
                    <th>CMIS Bill</th>
                    <th>Particulars</th>
                    <th>Sanction Amt</th>
                    <th>Amt Salaries</th>
                    <th>Exp Salaries</th>
                    <th>Bal Salaries</th>
                    <th>Amt Allowances</th>
                    <th>Exp Allowances</th>
                    <th>Bal Allowances</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Edit Budget Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeBudgetModal()">&times;</span>
            <h3>Edit Financial Year Budget</h3>
            <input type="text" id="editFy" placeholder="Financial Year (2026-27)">
            <br>
            <label>01-SALARIES Budget:</label>
            <input type="number" id="editSalBudget" step="0.01">
            <label>07-ALLOWANCES Budget:</label>
            <input type="number" id="editAllBudget" step="0.01">
            <button onclick="saveBudgetEdit()">Save Budget</button>
            <button onclick="closeBudgetModal()">Cancel</button>
        </div>
    </div>

    <!-- Edit Bill Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Edit Bill</h3>
            <input type="hidden" id="editIndex">
            <input type="date" id="editDate">
            <input type="text" id="editCmis" placeholder="CMIS Bill Number">
            <input type="text" id="editDept" placeholder="Department Bill Number">
            <textarea id="editPart" placeholder="Particulars"></textarea>
            <input type="number" id="editSanction" step="0.01" placeholder="Sanction Amount">
            <input type="number" id="editSal" step="0.01" placeholder="Amount on Salaries">
            <button onclick="saveEdit()">Save Changes</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        let data = { fy: '', salBudget: 0, allBudget: 0, bills: [] };
        let editIndex = -1;

        // INDIAN RUPEE FORMATTING
        function formatRupees(amount) {
            return new Intl.NumberFormat('en-IN').format(amount);
        }

        function generateFYOptions() {
            const select = document.getElementById('fySelector');
            const currentYear = new Date().getFullYear();
            select.innerHTML = '<option value="">Select FY</option>';
            
            for(let i = 5; i >= 0; i--) {
                const fy = (currentYear - i) + '-' + (currentYear - i + 1).toString().slice(-2);
                const option = document.createElement('option');
                option.value = fy;
                option.text = fy;
                select.appendChild(option);
            }
        }

        function createNewFY() {
            const newFY = prompt('Enter new Financial Year (e.g., 2026-27):');
            if (newFY && newFY.trim()) {
                switchFinancialYear(newFY);
            }
        }

        function switchFinancialYear(fy = document.getElementById('fySelector').value) {
            if (!fy) return;
            
            const saved = localStorage.getItem(`hcmFundData_${fy}`);
            if (saved) {
                data = JSON.parse(saved);
            } else {
                data = { fy: fy, salBudget: 0, allBudget: 0, bills: [] };
            }
            
            calculateAllRunningTotals();
            saveData();
            render();
            generateFYOptions();
            document.getElementById('fySelector').value = fy;
        }

        function loadData() {
            generateFYOptions();
            const currentFY = '2026-27';
            switchFinancialYear(currentFY);
        }

        function saveData() {
            localStorage.setItem(`hcmFundData_${data.fy}`, JSON.stringify(data));
        }

        function calculateRunningTotals(index) {
            for (let i = 0; i <= index; i++) {
                let bill = data.bills[i];
                bill.salExp = data.bills.slice(0, i + 1).reduce((sum, b) => sum + b.salAmt, 0);
                bill.allAmt = bill.sanctionAmt - bill.salAmt;
                bill.allExp = data.bills.slice(0, i + 1).reduce((sum, b) => sum + (b.sanctionAmt - b.salAmt), 0);
                bill.salBal = data.salBudget - bill.salExp;
                bill.allBal = data.allBudget - bill.allExp;
            }
        }

        function calculateAllRunningTotals() {
            data.bills.forEach((bill, index) => calculateRunningTotals(index));
        }

        function openBudgetModal() {
            document.getElementById('editFy').value = data.fy;
            document.getElementById('editSalBudget').value = data.salBudget;
            document.getElementById('editAllBudget').value = data.allBudget;
            document.getElementById('budgetModal').style.display = 'block';
        }

        function saveBudgetEdit() {
            data.fy = document.getElementById('editFy').value;
            data.salBudget = parseFloat(document.getElementById('editSalBudget').value) || 0;
            data.allBudget = parseFloat(document.getElementById('editAllBudget').value) || 0;
            calculateAllRunningTotals();
            saveData();
            closeBudgetModal();
            render();
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').style.display = 'none';
        }

        function addBill() {
            const bill = {
                date: document.getElementById('billDate').value,
                cmisBill: document.getElementById('cmisBill').value,
                deptBill: document.getElementById('deptBill').value,
                particulars: document.getElementById('particulars').value,
                sanctionAmt: parseFloat(document.getElementById('sanctionAmt').value) || 0,
                salAmt: parseFloat(document.getElementById('salAmt').value) || 0
            };
            if (!bill.date || !bill.deptBill) return alert('Date and Dept Bill required');
            data.bills.push(bill);
            calculateAllRunningTotals();
            saveData();
            render();
            clearAddForm();
        }

        function deleteBill(index) {
            if (confirm('Delete this bill?')) {
                data.bills.splice(index, 1);
                calculateAllRunningTotals();
                saveData();
                render();
            }
        }

        function editBill(index) {
            editIndex = index;
            const bill = data.bills[index];
            document.getElementById('editIndex').value = index;
            document.getElementById('editDate').value = bill.date;
            document.getElementById('editCmis').value = bill.cmisBill;
            document.getElementById('editDept').value = bill.deptBill;
            document.getElementById('editPart').value = bill.particulars;
            document.getElementById('editSanction').value = bill.sanctionAmt;
            document.getElementById('editSal').value = bill.salAmt;
            document.getElementById('editModal').style.display = 'block';
        }

        function saveEdit() {
            const index = parseInt(document.getElementById('editIndex').value);
            data.bills[index] = {
                date: document.getElementById('editDate').value,
                cmisBill: document.getElementById('editCmis').value,
                deptBill: document.getElementById('editDept').value,
                particulars: document.getElementById('editPart').value,
                sanctionAmt: parseFloat(document.getElementById('editSanction').value) || 0,
                salAmt: parseFloat(document.getElementById('editSal').value) || 0
            };
            calculateAllRunningTotals();
            saveData();
            closeModal();
            render();
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            editIndex = -1;
        }

        function render() {
            document.getElementById('currentBudget').innerHTML = data.fy ? `
                <div class="budget-box">
                    <strong>FY: ${data.fy}</strong><br>
                    01-SALARIES: â‚¹${formatRupees(data.salBudget)} | 
                    07-ALLOWANCES: â‚¹${formatRupees(data.allBudget)}
                </div>
            ` : '<p>Select or create Financial Year first</p>';

            const lastBill = data.bills[data.bills.length - 1];
            const totalSalExp = lastBill ? lastBill.salExp : 0;
            const totalAllExp = lastBill ? lastBill.allExp : 0;
            
            document.getElementById('summary').innerHTML = `
                <div class="budget-box">
                    <h3>01-SALARIES</h3>
                    <p>Budget: â‚¹${formatRupees(data.salBudget)}</p>
                    <p>Total Exp: â‚¹${formatRupees(totalSalExp)}</p>
                    <p class="balance ${data.salBudget - totalSalExp >= 0 ? 'positive' : 'negative'}">Balance: â‚¹${formatRupees(data.salBudget - totalSalExp)}</p>
                </div>
                <div class="budget-box">
                    <h3>07-ALLOWANCES</h3>
                    <p>Budget: â‚¹${formatRupees(data.allBudget)}</p>
                    <p>Total Exp: â‚¹${formatRupees(totalAllExp)}</p>
                    <p class="balance ${data.allBudget - totalAllExp >= 0 ? 'positive' : 'negative'}">Balance: â‚¹${formatRupees(data.allBudget - totalAllExp)}</p>
                </div>
            `;

            const tbody = document.getElementById('billsTable').querySelector('tbody');
            tbody.innerHTML = '';
            data.bills.forEach((bill, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${bill.date}</td>
                    <td>HCM/${bill.deptBill}</td>
                    <td>${bill.cmisBill}</td>
                    <td>${bill.particulars.substring(0, 40)}${bill.particulars.length > 40 ? '...' : ''}</td>
                    <td>â‚¹${formatRupees(bill.sanctionAmt)}</td>
                    <td>â‚¹${formatRupees(bill.salAmt)}</td>
                    <td>â‚¹${formatRupees(bill.salExp)}</td>
                    <td class="${bill.salBal >= 0 ? 'positive' : 'negative'}">â‚¹${formatRupees(bill.salBal)}</td>
                    <td>â‚¹${formatRupees(bill.allAmt)}</td>
                    <td>â‚¹${formatRupees(bill.allExp)}</td>
                    <td class="${bill.allBal >= 0 ? 'positive' : 'negative'}">â‚¹${formatRupees(bill.allBal)}</td>
                    <td class="action-col">
                        <button class="btn-edit" onclick="editBill(${index})">Edit</button>
                        <button class="btn-delete" onclick="deleteBill(${index})">Delete</button>
                    </td>
                `;
            });
        }

        function clearAddForm() {
            document.getElementById('billDate').value = '';
            document.getElementById('cmisBill').value = '';
            document.getElementById('deptBill').value = '';
            document.getElementById('particulars').value = '';
            document.getElementById('sanctionAmt').value = '';
            document.getElementById('salAmt').value = '';
        }

        function generateBillsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`HCM Fund Register - Bills List FY ${data.fy || 'N/A'}`, 20, 20);
            doc.setFontSize(12);
            
            let y = 40;
            data.bills.forEach((bill, index) => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.text(`Bill ${index + 1}:`, 20, y);
                y += 5;
                doc.text(`${bill.date} | HCM/${bill.deptBill} | ${bill.cmisBill}`, 25, y);
                y += 5;
                doc.text(`Particulars: ${bill.particulars.substring(0, 80)}${bill.particulars.length > 80 ? '...' : ''}`, 25, y);
                y += 7;
                doc.text(`Sanction: â‚¹${formatRupees(bill.sanctionAmt)} | Sal: â‚¹${formatRupees(bill.salAmt)} | All: â‚¹${formatRupees(bill.allAmt)}`, 25, y);
                y += 7;
                doc.text(`Sal Exp: â‚¹${formatRupees(bill.salExp)} | Sal Bal: â‚¹${formatRupees(bill.salBal)}`, 25, y);
                y += 7;
                doc.text(`All Exp: â‚¹${formatRupees(bill.allExp)} | All Bal: â‚¹${formatRupees(bill.allBal)}`, 25, y);
                y += 10;
            });
            doc.save(`HCM-Bills-Register-${data.fy || 'current'}.pdf`);
        }

        window.onclick = function(event) {
            const budgetModal = document.getElementById('budgetModal');
            const editModal = document.getElementById('editModal');
            if (event.target == budgetModal) closeBudgetModal();
            if (event.target == editModal) closeModal();
        }

        loadData();
        render();
    </script>
</body>
</html>
